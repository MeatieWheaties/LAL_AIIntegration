@page "/kobolds"
@rendermode InteractiveServer
@using LunchAndLearn_AIIntegration.AI
@using LunchAndLearn_AIIntegration.Data
@using LunchAndLearn_AIIntegration.Data.Models
@using LunchAndLearn_AIIntegration.Data.Repositories
@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Internal

@inject IDbContextFactory<DB> _db;
@inject NavigationManager _nav;
@inject AiService _ai;
@inject AIRepository _aiRepo;
@inject KoboldRepository _koboldRepo;

<MudCard>
	<MudGrid>
		<MudItem xs="8">
			<MudTable Items="_Kobold.Keys" Context="_">
				<HeaderContent>
					<MudTh>Kobold</MudTh>
					<MudTh>Message</MudTh>
					<MudTh>Ranking</MudTh>
					<MudTh></MudTh>
					<MudTh></MudTh>
					<MudTh></MudTh>
				</HeaderContent>
				<RowTemplate>
					<MudTd>@(_Kobold[_].Name)</MudTd>
					<MudTd>@(_Kobold[_].Message)</MudTd>
					<MudTd>@(_AI_Assessments.ContainsKey(_) ? _AI_Assessments[_].ConfidenceLevel.ToString() : "")</MudTd>
					<MudTd><MudButton OnClick="@(() => Assess(_))">Assess</MudButton></MudTd>
					<MudTd><MudButton OnClick="@(() => _nav.NavigateTo($"kobold/{_}"))">Details</MudButton></MudTd>
					<MudTd><MudButton OnClick="@(() => RemoveKobold(_))">Delete</MudButton></MudTd>
				</RowTemplate>
			</MudTable>
		</MudItem>
		<MudItem xs="4">
			<MudForm>
				<MudInput Label="Kobold Name" @bind-Value=Kobold_Name />
				<MudTextField Label="Message" @bind-Value=Kobold_Message />
				<MudButton Disabled=@(string.IsNullOrEmpty(Kobold_Name) || string.IsNullOrEmpty(Kobold_Message)) OnClick="@(() => AddKobold(Kobold_Name, Kobold_Message))">Add</MudButton>
			</MudForm>
		</MudItem>
	</MudGrid>
</MudCard>

@code {

	Dictionary<int, Kobold> _Kobold { get; set; } = new Dictionary<int, Kobold>();
	Dictionary<int, Assessment> _AI_Assessments { get; set; } = new Dictionary<int, Assessment>();

	#region New Kobold Entry

	string Kobold_Name { get; set;} = string.Empty;
	string Kobold_Message { get; set; } = string.Empty;

	protected async Task AddKobold(string koboldName, string koboldMessage)
	{
		try
		{
			using var _ = await _db.CreateDbContextAsync();

			var _kobold = await _koboldRepo.AddKobold(koboldName, koboldMessage);

			if (_kobold != null)
			{
				await _ai.AssessKobold(_kobold.Id);
				StateHasChanged();
			}
		}
		catch (Exception)
		{

		}
		finally
		{
			_Kobold = await GetKobolds();
			_AI_Assessments = await GetKoboldAssessments();
		}
	}

	protected async Task RemoveKobold(int id)
	{
		var _result = await _koboldRepo.RemoveKobold(id);
		if (_result)
		{
			_Kobold = await GetKobolds();
			_AI_Assessments = await GetKoboldAssessments();
			StateHasChanged();
		}
	}

	#endregion

	protected async Task Assess(int id)
	{
		await _ai.AssessKobold(id);
		_AI_Assessments = await GetKoboldAssessments();
		StateHasChanged();
	}

	protected override async Task OnParametersSetAsync()
	{
		_Kobold = await GetKobolds();
		_AI_Assessments = await GetKoboldAssessments();
	}

	async Task<Dictionary<int, Kobold>> GetKobolds()
	{
		using var _context = await _db.CreateDbContextAsync();
		try
		{
			var _result = new Dictionary<int, Kobold>();
			foreach(var _kobold in _context.Kobolds)
			{
				_result.Add(_kobold.Id, _kobold);
			}
			return _result;
		}
		catch (Exception)
		{
			return new Dictionary<int, Kobold>();
		}
	}

	async Task<Dictionary<int, Assessment>> GetKoboldAssessments()
	{
		return await _aiRepo.GetAssessmentsAsync();
	}
}
